================================================================================
VYRU5 ‚Äî –ë–ò–¢–í–ê –í–ò–†–£–°–û–í "–ù–ï–ô–†–û–ù–´"
–í–µ—Ä—Å–∏—è: v13
–î–∞—Ç–∞: 2026-02-17
–°—Ç–∞—Ç—É—Å: –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
================================================================================

================================================================================
–ß–ê–°–¢–¨ 1: –°–ï–†–í–ï–† ‚Äî –ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–ï–¢–ö–ò (server/src/rooms/HoldingRoom.ts)
================================================================================

–§–ê–ô–õ: server/src/rooms/HoldingRoom.ts

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ startVirusBattle():

```typescript
private startVirusBattle(): void {
  console.log('Starting virus battle!');

  // –ù–û–í–ê–Ø –°–ï–¢–ö–ê: 64√ó36 = 2304 –∫–ª–µ—Ç–∫–∏ (—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 16:9)
  const width = 64;
  const height = 36;
  this.state.battleGrid = new Array(width * height).fill(0);
  this.state.battleActive = true;

  const players = Array.from(this.state.players.values());
  if (players.length >= 2) {
    const playerA = players.find(p => p.isRoomCreator) || players[0];
    const playerB = players.find(p => !p.isRoomCreator) || players[1];

    // VirusA: x=32, y=2 (–≤–µ—Ä—Ö–Ω–∏–π —Ü–µ–Ω—Ç—Ä)
    const topCenterX = 32;
    const topCenterY = 2;
    const topIndex = topCenterY * width + topCenterX;
    this.state.battleGrid[topIndex] = 1;

    // VirusB: x=32, y=33 (–Ω–∏–∂–Ω–∏–π —Ü–µ–Ω—Ç—Ä)
    const bottomCenterX = 32;
    const bottomCenterY = 33;
    const bottomIndex = bottomCenterY * width + bottomCenterX;
    this.state.battleGrid[bottomIndex] = 2;
  }

  this.broadcast('virusBattleStarted', {
    message: 'Virus battle has started!',
    battleGrid: this.state.battleGrid,
    width: width,
    height: height,
    timestamp: Date.now()
  });

  this.startBattleSimulation(width, height);
}
```

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ startBattleSimulation():

```typescript
private startBattleSimulation(width: number, height: number): void {
  let tickCount = 0;
  const maxTicks = 3000; // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 1000 –¥–æ 3000
  
  // –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Ç–∏–∫: 100–º—Å –≤–º–µ—Å—Ç–æ 1000–º—Å
  const battleInterval = setInterval(() => {
    this.updateVirusSpread(width, height);

    if (this.checkWinConditions()) {
      clearInterval(battleInterval);
      this.endVirusBattle();
      return;
    }

    tickCount++;

    if (tickCount > maxTicks || !this.state.battleActive) {
      clearInterval(battleInterval);
      this.endVirusBattle();
    }
  }, 100); // 100–º—Å = 0.1 —Å–µ–∫

  (this as any).battleInterval = battleInterval;
}
```

–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ calculateVirusPower():

```typescript
private calculateVirusPower(
  player: PlayerSchema, 
  isAttacking: boolean,
  x: number, 
  y: number
): number {
  const params = player.virusParams;
  let power = 10; // –±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞

  if (isAttacking) {
    // –ê—Ç–∞–∫—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    power += (params.get('aggression') || 0) * 1.5;
    power += (params.get('virulence') || 0) * 1.0;
    power += (params.get('speed') || 0) * 0.5;
    power += (params.get('mobility') || 0) * 0.5;
    power += (params.get('lethality') || 0) * 2.0;
  } else {
    // –ó–∞—â–∏—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    power += (params.get('defense') || 0) * 2.0;
    power += (params.get('resilience') || 0) * 1.0;
    power += (params.get('stealth') || 0) * 3.0;
  }

  // Mutation: —Å–ª—É—á–∞–π–Ω—ã–π –±–æ–Ω—É—Å 0-20%
  const mutationBonus = Math.random() * (params.get('mutation') || 0) * 0.02;
  power *= 1 + mutationBonus;

  // Intellect: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫
  if ((params.get('intellect') || 0) > 5 && this.isStrategicPosition(x, y)) {
    power *= 1.3;
  }

  return power;
}

private isStrategicPosition(x: number, y: number): boolean {
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏: —Ü–µ–Ω—Ç—Ä, —É–≥–ª—ã, —Å–µ—Ä–µ–¥–∏–Ω—ã —Å—Ç–æ—Ä–æ–Ω
  const width = 64;
  const height = 36;
  const centerX = Math.floor(width / 2);
  const centerY = Math.floor(height / 2);

  // –¶–µ–Ω—Ç—Ä –ø–æ–ª—è
  if (Math.abs(x - centerX) <= 5 && Math.abs(y - centerY) <= 5) {
    return true;
  }

  // –£–≥–ª—ã
  if ((x <= 5 || x >= width - 5) && (y <= 5 || y >= height - 5)) {
    return true;
  }

  return false;
}
```

–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥ updateVirusSpread():

```typescript
private updateVirusSpread(width: number, height: number): void {
  const newGrid = [...this.state.battleGrid];
  const players = Array.from(this.state.players.values());
  const playerA = players.find(p => p.isRoomCreator) || players[0];
  const playerB = players.find(p => !p.isRoomCreator) || players[1];

  // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–ª–µ—Ç–∫–∞–º
  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const idx = y * width + x;
      const cell = this.state.battleGrid[idx];

      if (cell !== 0) {
        // 8 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
        const neighbors = [
          {x: x-1, y: y}, {x: x+1, y: y},
          {x: x, y: y-1}, {x: x, y: y+1},
          {x: x-1, y: y-1}, {x: x+1, y: y-1},
          {x: x-1, y: y+1}, {x: x+1, y: y+1}
        ];

        for (const neighbor of neighbors) {
          if (neighbor.x >= 0 && neighbor.x < width && 
              neighbor.y >= 0 && neighbor.y < height) {
            const nIdx = neighbor.y * width + neighbor.x;
            const neighborCell = this.state.battleGrid[nIdx];

            if (neighborCell === 0) {
              // –ü—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞ ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å
              const attacker = cell === 1 ? playerA : playerB;
              const attackPower = this.calculateVirusPower(attacker, true, x, y);
              const captureChance = Math.min(0.7, attackPower / 50);

              if (Math.random() < captureChance) {
                newGrid[nIdx] = cell;
              }
            } else if (neighborCell !== cell) {
              // –í—Ä–∞–∂–µ—Å–∫–∞—è –∫–ª–µ—Ç–∫–∞ ‚Äî –±–∏—Ç–≤–∞
              const attacker = cell === 1 ? playerA : playerB;
              const defender = cell === 1 ? playerB : playerA;
              
              const attackPower = this.calculateVirusPower(attacker, true, x, y);
              const defensePower = this.calculateVirusPower(defender, false, neighbor.x, neighbor.y);
              
              const winChance = attackPower / (attackPower + defensePower);
              
              if (Math.random() < winChance) {
                newGrid[nIdx] = cell; // –ê—Ç–∞–∫—É—é—â–∏–π –ø–æ–±–µ–¥–∏–ª
              }
            }
          }
        }
      }
    }
  }

  this.state.battleGrid = newGrid;

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é —Å–µ—Ç–∫—É –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
  this.broadcast('virusTick', {
    tick: Date.now(),
    battleGrid: this.state.battleGrid,
    width: width,
    height: height
  });
}
```

================================================================================
–ß–ê–°–¢–¨ 2: BATTLE MANAGER (client/src/features/battle/BattleManager.ts)
================================================================================

–§–ê–ô–õ: client/src/features/battle/BattleManager.ts

```typescript
/**
 * BattleManager ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –±–∏—Ç–≤—ã –≤–∏—Ä—É—Å–æ–≤
 */

export type BattleStateType = 'idle' | 'preparing' | 'running' | 'ended';

export type BattleState = 
  | { type: 'idle' }
  | { type: 'preparing'; startTime: number }
  | { type: 'running'; startTime: number; tick: number }
  | { type: 'ended'; winner: 'A' | 'B' | 'draw'; virusACount: number; virusBCount: number };

export interface BattleGridData {
  grid: number[];
  width: number;
  height: number;
}

export class BattleManager {
  private state: BattleState = { type: 'idle' };
  private gridData: BattleGridData | null = null;
  private onStateChangeCallback?: (state: BattleState) => void;
  private onGridUpdateCallback?: (grid: number[]) => void;

  constructor() {
    console.log('[BattleManager] Created');
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   */
  getState(): BattleState {
    return this.state;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Ç–∫–∏
   */
  getGridData(): BattleGridData | null {
    return this.gridData;
  }

  /**
   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å callback –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   */
  setOnStateChange(callback: (state: BattleState) => void): void {
    this.onStateChangeCallback = callback;
  }

  /**
   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å callback –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∫–∏
   */
  setOnGridUpdate(callback: (grid: number[]) => void): void {
    this.onGridUpdateCallback = callback;
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞—á–∞–ª–æ –±–∏—Ç–≤—ã
   */
  onBattleStarted(data: { battleGrid: number[]; width: number; height: number }): void {
    console.log('[BattleManager] Battle started');
    
    this.gridData = {
      grid: data.battleGrid,
      width: data.width,
      height: data.height
    };

    this.state = {
      type: 'running',
      startTime: Date.now(),
      tick: 0
    };

    if (this.onStateChangeCallback) {
      this.onStateChangeCallback(this.state);
    }

    if (this.onGridUpdateCallback && this.gridData) {
      this.onGridUpdateCallback(this.gridData.grid);
    }
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∏–∫ –±–∏—Ç–≤—ã
   */
  onBattleTick(data: { battleGrid: number[]; tick: number }): void {
    if (this.state.type !== 'running') return;

    this.gridData = {
      grid: data.battleGrid,
      width: this.gridData?.width || 64,
      height: this.gridData?.height || 36
    };

    this.state = {
      ...this.state,
      tick: data.tick
    };

    if (this.onGridUpdateCallback && this.gridData) {
      this.onGridUpdateCallback(this.gridData.grid);
    }
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ –±–∏—Ç–≤—ã
   */
  onBattleEnded(data: { 
    winner: string; 
    virusACount: number; 
    virusBCount: number 
  }): void {
    console.log('[BattleManager] Battle ended:', data.winner);

    let winner: 'A' | 'B' | 'draw' = 'draw';
    if (data.virusACount > data.virusBCount) {
      winner = 'A';
    } else if (data.virusBCount > data.virusACount) {
      winner = 'B';
    }

    this.state = {
      type: 'ended',
      winner,
      virusACount: data.virusACount,
      virusBCount: data.virusBCount
    };

    if (this.onStateChangeCallback) {
      this.onStateChangeCallback(this.state);
    }
  }

  /**
   * –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   */
  reset(): void {
    this.state = { type: 'idle' };
    this.gridData = null;

    if (this.onStateChangeCallback) {
      this.onStateChangeCallback(this.state);
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏–¥—ë—Ç –ª–∏ –±–∏—Ç–≤–∞
   */
  isRunning(): boolean {
    return this.state.type === 'running';
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ –±–∏—Ç–≤–∞
   */
  isEnded(): boolean {
    return this.state.type === 'ended';
  }
}
```

================================================================================
–ß–ê–°–¢–¨ 3: BATTLE RENDERER (client/src/features/battle/BattleRenderer.ts)
================================================================================

–§–ê–ô–õ: client/src/features/battle/BattleRenderer.ts

```typescript
/**
 * BattleRenderer ‚Äî –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –±–∏—Ç–≤—ã –≤–∏—Ä—É—Å–æ–≤ –≤ —Å—Ç–∏–ª–µ "–Ω–µ–π—Ä–æ–Ω—ã"
 * 
 * –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å:
 * - –ö–∞–∂–¥–∞—è –∫–ª–µ—Ç–∫–∞ ‚Äî –∫—Ä—É–≥ (–Ω–µ–π—Ä–æ–Ω)
 * - –ö–ª–µ—Ç–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω—ã –ª–∏–Ω–∏—è–º–∏ (—Å–∏–Ω–∞–ø—Å—ã)
 * - –ü—É–ª—å—Å–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫
 * - Mer—Ü–∞–Ω–∏–µ contested –∫–ª–µ—Ç–æ–∫
 */

import * as PIXI from 'pixi.js';

export interface BattleRendererConfig {
  cellDiameter: number;      // –î–∏–∞–º–µ—Ç—Ä –∫–ª–µ—Ç–∫–∏ (15px –¥–µ—Å–∫—Ç–æ–ø, 10px –º–æ–±–∏–ª–∫–∞)
  cellGap: number;           // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–ª–µ—Ç–∫–∞–º–∏ (2px)
  pulseSpeed: number;        // –°–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å—Å–∞—Ü–∏–∏ (2 —Å–µ–∫ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)
  contestedFlickerSpeed: number; // –°–∫–æ—Ä–æ—Å—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è contested
}

export class BattleRenderer {
  private container: PIXI.Container;
  private cellContainers: Map<number, PIXI.Container> = new Map();
  private linesContainer: PIXI.Graphics;
  private config: BattleRendererConfig;
  
  private gridWidth: number = 64;
  private gridHeight: number = 36;
  private totalCells: number = this.gridWidth * this.gridHeight;
  
  // –¶–≤–µ—Ç–∞
  private readonly COLORS = {
    empty: 0x1a1a1a,
    virusA: 0xff0000,
    virusB: 0x0000ff,
    contested: 0xff00ff,
    lineEmpty: 0x333333,
    lineActive: 0x666666
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
  private pulseTime: number = 0;
  private contestedTime: number = 0;

  constructor(
    stage: PIXI.Container,
    config?: Partial<BattleRendererConfig>
  ) {
    this.container = new PIXI.Container();
    this.linesContainer = new PIXI.Graphics();
    this.container.addChild(this.linesContainer);
    
    this.config = {
      cellDiameter: 15,
      cellGap: 2,
      pulseSpeed: 2000,
      contestedFlickerSpeed: 200,
      ...config
    };

    this.container.zIndex = 100; // –ù–∏–∂–µ draggable orb, –≤—ã—à–µ —Ñ–æ–Ω–∞
    this.container.alpha = 0; // –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    this.container.visible = false;

    stage.addChild(this.container);
    console.log('[BattleRenderer] Created');
  }

  /**
   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É
   */
  initGrid(width: number, height: number): void {
    this.gridWidth = width;
    this.gridHeight = height;
    this.totalCells = width * height;

    console.log(`[BattleRenderer] Init grid: ${width}√ó${height} = ${this.totalCells} cells`);

    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–µ—Ç–∫–∏
    this.cellContainers.forEach(container => {
      this.container.removeChild(container);
      container.destroy({ children: true });
    });
    this.cellContainers.clear();
    this.linesContainer.clear();

    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const idx = y * width + x;
        const container = this.createCellContainer(x, y);
        this.cellContainers.set(idx, container);
        this.container.addChild(container);
      }
    }

    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏-—Å–∏–Ω–∞–ø—Å—ã
    this.drawSynapses();

    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–µ—Ç–∫—É
    this.centerGrid();
  }

  /**
   * –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–ª–µ—Ç–∫–∏
   */
  private createCellContainer(x: number, y: number): PIXI.Container {
    const container = new PIXI.Container();
    
    const cell = new PIXI.Graphics();
    const diameter = this.config.cellDiameter;
    const radius = diameter / 2;
    
    // –†–∏—Å—É–µ–º –∫—Ä—É–≥ (–Ω–µ–π—Ä–æ–Ω)
    cell.beginFill(this.COLORS.empty, 1);
    cell.drawCircle(0, 0, radius);
    cell.endFill();
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–µ–Ω–∏–µ
    const glow = new PIXI.Graphics();
    glow.beginFill(this.COLORS.empty, 0.3);
    glow.drawCircle(0, 0, radius + 2);
    glow.endFill();

    container.addChild(glow);
    container.addChild(cell);
    container.name = `cell_${x}_${y}`;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    (container as any).cellGraphics = cell;
    (container as any).glowGraphics = glow;

    return container;
  }

  /**
   * –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ª–∏–Ω–∏–∏-—Å–∏–Ω–∞–ø—Å—ã –º–µ–∂–¥—É —Å–æ—Å–µ–¥—è–º–∏
   */
  private drawSynapses(): void {
    this.linesContainer.clear();
    this.linesContainer.lineStyle(1, this.COLORS.lineEmpty, 0.5);

    const diameter = this.config.cellDiameter;
    const gap = this.config.cellGap;
    const step = diameter + gap;

    for (let y = 0; y < this.gridHeight; y++) {
      for (let x = 0; x < this.gridWidth; x++) {
        const idx = y * this.gridWidth + x;
        const container = this.cellContainers.get(idx);
        if (!container) continue;

        const x1 = container.position.x;
        const y1 = container.position.y;

        // –°–æ–µ–¥–∏–Ω—è–µ–º —Å –ø—Ä–∞–≤—ã–º –∏ –Ω–∏–∂–Ω–∏–º —Å–æ—Å–µ–¥—è–º–∏ (8 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
        const neighbors = [
          {dx: 1, dy: 0},   // –ø—Ä–∞–≤–æ
          {dx: 0, dy: 1},   // –Ω–∏–∑
          {dx: 1, dy: 1},   // –ø—Ä–∞–≤–æ-–Ω–∏–∑
          {dx: -1, dy: 1}   // –ª–µ–≤–æ-–Ω–∏–∑
        ];

        for (const neighbor of neighbors) {
          const nx = x + neighbor.dx;
          const ny = y + neighbor.dy;

          if (nx >= 0 && nx < this.gridWidth && ny >= 0 && ny < this.gridHeight) {
            const nIdx = ny * this.gridWidth + nx;
            const nContainer = this.cellContainers.get(nIdx);
            if (nContainer) {
              const x2 = nContainer.position.x;
              const y2 = nContainer.position.y;
              
              this.linesContainer.moveTo(x1, y1);
              this.linesContainer.lineTo(x2, y2);
            }
          }
        }
      }
    }
  }

  /**
   * –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
   */
  private centerGrid(): void {
    const diameter = this.config.cellDiameter;
    const gap = this.config.cellGap;
    const step = diameter + gap;

    const gridWidthPx = this.gridWidth * step;
    const gridHeightPx = this.gridHeight * step;

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–ª–µ—Ç–∫—É
    this.cellContainers.forEach((container, idx) => {
      const x = idx % this.gridWidth;
      const y = Math.floor(idx / this.gridWidth);

      container.position.x = x * step + step / 2;
      container.position.y = y * step + step / 2;
    });

    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    this.container.position.x = (window.innerWidth - gridWidthPx) / 2 + step / 2;
    this.container.position.y = (window.innerHeight - gridHeightPx) / 2 + step / 2;
  }

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∫–∏
   */
  updateGrid(grid: number[]): void {
    if (grid.length !== this.totalCells) {
      console.error('[BattleRenderer] Grid size mismatch');
      return;
    }

    for (let i = 0; i < this.totalCells; i++) {
      const cellValue = grid[i];
      const container = this.cellContainers.get(i);
      
      if (container) {
        this.updateCell(container, cellValue);
      }
    }
  }

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–ª–µ—Ç–∫—É
   */
  private updateCell(container: PIXI.Container, value: number): void {
    const cell = (container as any).cellGraphics as PIXI.Graphics;
    const glow = (container as any).glowGraphics as PIXI.Graphics;

    if (!cell || !glow) return;

    cell.clear();
    glow.clear();

    const diameter = this.config.cellDiameter;
    const radius = diameter / 2;

    if (value === 0) {
      // Empty –∫–ª–µ—Ç–∫–∞
      cell.beginFill(this.COLORS.empty, 1);
      cell.drawCircle(0, 0, radius);
      cell.endFill();

      glow.beginFill(this.COLORS.empty, 0.3);
      glow.drawCircle(0, 0, radius + 2);
      glow.endFill();
    } else if (value === 1) {
      // VirusA (–∫—Ä–∞—Å–Ω—ã–π)
      const pulse = this.getPulseValue();
      cell.beginFill(this.COLORS.virusA, 1);
      cell.drawCircle(0, 0, radius * pulse);
      cell.endFill();

      glow.beginFill(this.COLORS.virusA, 0.5);
      glow.drawCircle(0, 0, radius * pulse + 3);
      glow.endFill();
    } else if (value === 2) {
      // VirusB (—Å–∏–Ω–∏–π)
      const pulse = this.getPulseValue();
      cell.beginFill(this.COLORS.virusB, 1);
      cell.drawCircle(0, 0, radius * pulse);
      cell.endFill();

      glow.beginFill(this.COLORS.virusB, 0.5);
      glow.drawCircle(0, 0, radius * pulse + 3);
      glow.endFill();
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É–ª—å—Å–∞—Ü–∏–∏ (1.0 ‚Üí 1.1 ‚Üí 1.0)
   */
  private getPulseValue(): number {
    const time = Date.now() % this.config.pulseSpeed;
    const normalized = time / this.config.pulseSpeed; // 0 ‚Üí 1
    return 1 + 0.1 * Math.sin(normalized * Math.PI * 2);
  }

  /**
   * –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É
   */
  show(): void {
    this.container.alpha = 1;
    this.container.visible = true;
    console.log('[BattleRenderer] Show');
  }

  /**
   * –°–∫—Ä—ã—Ç—å —Å–µ—Ç–∫—É
   */
  hide(): void {
    this.container.alpha = 0;
    this.container.visible = false;
    console.log('[BattleRenderer] Hide');
  }

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å (–≤—ã–∑—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)
   */
  update(delta: number): void {
    this.pulseTime += delta;
    this.contestedTime += delta;

    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –∑–¥–µ—Å—å
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
   */
  destroy(): void {
    this.cellContainers.forEach(container => {
      container.destroy({ children: true });
    });
    this.cellContainers.clear();
    this.linesContainer.destroy();
    this.container.destroy();
    console.log('[BattleRenderer] Destroyed');
  }
}
```

================================================================================
–ß–ê–°–¢–¨ 4: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í MAIN.TS
================================================================================

–§–ê–ô–õ: client/src/main.ts

–î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç:
```typescript
import { BattleManager } from './features/battle/BattleManager';
import { BattleRenderer } from './features/battle/BattleRenderer';
```

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –∫–ª–∞—Å—Å MainApp:
```typescript
private battleManager!: BattleManager;
private battleRenderer!: BattleRenderer;
```

–°–æ–∑–¥–∞—Ç—å –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ:
```typescript
console.log('[MainApp] Creating BattleManager...');
this.battleManager = new BattleManager();
console.log('[MainApp] BattleManager created');
```

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ PixiJS:
```typescript
// –°–æ–∑–¥–∞—ë–º BattleRenderer –ü–û–°–õ–ï –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PixiJS
console.log('[MainApp] Creating BattleRenderer...');
this.battleRenderer = new BattleRenderer(this.gameEngine.app!.stage);
console.log('[MainApp] BattleRenderer created');
```

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ setupInteractions():
```typescript
// BattleManager callbacks
this.battleManager.setOnStateChange((state) => {
  console.log('[MainApp] Battle state changed:', state);
  
  if (state.type === 'running') {
    this.battleRenderer.show();
  } else if (state.type === 'ended') {
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    alert(`Battle ended! Winner: ${state.winner}`);
  }
});

this.battleManager.setOnGridUpdate((grid) => {
  this.battleRenderer.updateGrid(grid);
});

// Network listeners –¥–ª—è –±–∏—Ç–≤—ã
this.networkManager.onVirusBattleStarted = (data) => {
  this.battleManager.onBattleStarted(data);
};

this.networkManager.onVirusTick = (tick, data) => {
  this.battleManager.onBattleTick(data);
};

this.networkManager.onVirusBattleEnded = (message) => {
  // Parse winner from message or data
  this.battleManager.onBattleEnded({
    winner: 'A', // TODO: parse from server
    virusACount: 0,
    virusBCount: 0
  });
};
```

–î–æ–±–∞–≤–∏—Ç—å update –≤ game loop:
```typescript
// –í gameEngine.addTickerUpdate
this.gameEngine.addTickerUpdate((dt) => {
  this.battleRenderer.update(dt);
});
```

================================================================================
–ß–ê–°–¢–¨ 5: –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –õ–ê–ù–î–®–ê–§–¢ (client/index.html)
================================================================================

–î–æ–±–∞–≤–∏—Ç—å CSS –≤ <style>:
```css
/* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ª–∞–Ω–¥—à–∞—Ñ—Ç */
#rotateScreen {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #0f0f23;
  color: #00ff00;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  font-family: 'PIXY', 'Courier New', monospace;
}

@media (orientation: portrait) {
  #rotateScreen {
    display: flex;
  }
  #gameScreen {
    display: none !important;
  }
}

@media (orientation: landscape) {
  #rotateScreen {
    display: none;
  }
  #gameScreen {
    display: flex !important;
  }
}
```

–î–æ–±–∞–≤–∏—Ç—å HTML –ø–æ—Å–ª–µ <body>:
```html
<!-- –≠–∫—Ä–∞–Ω –ø–æ–≤–æ—Ä–æ—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
<div id="rotateScreen">
  <div style="font-size: 3rem; margin-bottom: 20px;">üì±</div>
  <div style="font-size: 1.5rem;">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</div>
  <div style="font-size: 1rem; color: #00ffff; margin-top: 10px;">
    –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
  </div>
</div>
```

================================================================================
–ß–ê–°–¢–¨ 6: –û–ë–ù–û–í–õ–ï–ù–ò–ï NetworkManager.ts
================================================================================

–§–ê–ô–õ: client/src/core/NetworkManager.ts

–î–æ–±–∞–≤–∏—Ç—å callbacks:
```typescript
onVirusBattleStarted?: (data: { 
  battleGrid: number[]; 
  width: number; 
  height: number;
  message: string;
  timestamp: number;
}) => void;

onVirusTick?: (tick: number, data: {
  battleGrid: number[];
  width: number;
  height: number;
}) => void;

onVirusBattleEnded?: (data: {
  message: string;
  winner: string;
  virusACount: number;
  virusBCount: number;
  timestamp: number;
}) => void;
```

–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ setupRoomMessageHandlers():
```typescript
// Virus battle messages
this.currentRoom.onMessage('virusBattleStarted', (data) => {
  if (this.onVirusBattleStarted) {
    this.onVirusBattleStarted(data);
  }
});

this.currentRoom.onMessage('virusTick', (data) => {
  if (this.onVirusTick) {
    this.onVirusTick(data.tick, data);
  }
});

this.currentRoom.onMessage('virusBattleEnded', (data) => {
  if (this.onVirusBattleEnded) {
    this.onVirusBattleEnded(data);
  }
});
```

================================================================================
–ß–ê–°–¢–¨ 7: –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –ú–û–ë–ò–õ–¨–ù–´–ï (client/index.html)
================================================================================

–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö:
```css
@media (max-width: 768px) {
  #topPanelWrapper {
    width: calc(100% - 20px);
    padding: 0 10px;
  }
  
  #player1Name, #player2Name {
    font-size: 12px;
    min-width: 60px;
  }
  
  #topRoomIdPanel {
    font-size: 11px;
    padding: 6px 10px;
  }
  
  /* Battle renderer mobile */
  .battle-cell {
    diameter: 10px;
  }
}
```

================================================================================
–ß–ê–°–¢–¨ 8: –í–ò–ó–£–ê–õ–¨–ù–´–ï –≠–§–§–ï–ö–¢–´ –ü–ê–†–ê–ú–ï–¢–†–û–í (BattleRenderer.ts)
================================================================================

–î–æ–±–∞–≤–∏—Ç—å –≤ BattleRenderer –º–µ—Ç–æ–¥ applyParamEffects():

```typescript
applyParamEffects(playerParams: Map<string, number>, isPlayerA: boolean): void {
  const speed = playerParams.get('speed') || 0;
  const stealth = playerParams.get('stealth') || 0;
  const mutation = playerParams.get('mutation') || 0;
  const lethality = playerParams.get('lethality') || 0;

  // Speed: —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å—Å–∞—Ü–∏–∏
  this.config.pulseSpeed = 2000 - (speed * 100); // 2000ms ‚Üí 1000ms

  this.cellContainers.forEach((container, idx) => {
    const cellValue = this.getCurrentCellValue(idx);
    
    if ((isPlayerA && cellValue === 1) || (!isPlayerA && cellValue === 2)) {
      // Stealth: –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
      const alpha = 1 - (stealth / 20); // 1.0 ‚Üí 0.5
      container.alpha = alpha;

      // Mutation: —Ü–≤–µ—Ç–æ–≤–æ–π —Å–¥–≤–∏–≥
      if (mutation > 5) {
        const hueRotate = (Date.now() / 100) % 360;
        container.filters = [
          new PIXI.filters.ColorMatrixFilter()
        ];
        // TODO: –¥–æ–±–∞–≤–∏—Ç—å hue rotation
      }

      // Lethality: —á—ë—Ä–Ω–∞—è –∞—É—Ä–∞
      if (lethality > 5) {
        const glow = (container as any).glowGraphics as PIXI.Graphics;
        glow.clear();
        glow.beginFill(0x000000, 0.8);
        glow.drawCircle(0, 0, this.config.cellDiameter / 2 + 4);
        glow.endFill();
      }
    }
  });
}
```

================================================================================
–ß–ê–°–¢–¨ 9: –¢–ò–ü–´ –î–õ–Ø NetworkManager (client/src/types/schema.ts)
================================================================================

–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã:
```typescript
export interface VirusBattleStartedMessage {
  battleGrid: number[];
  width: number;
  height: number;
  message: string;
  timestamp: number;
}

export interface VirusTickMessage {
  tick: number;
  battleGrid: number[];
  width: number;
  height: number;
}

export interface VirusBattleEndedMessage {
  message: string;
  winner: string;
  virusACount: number;
  virusBCount: number;
  timestamp: number;
}
```

================================================================================
–ß–ê–°–¢–¨ 10: –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –ó–ê–í–ï–†–®–ï–ù–ò–ï–ú
================================================================================

–ß–µ–∫-–ª–∏—Å—Ç:
- [ ] –°–µ—Ä–≤–µ—Ä: —Å–µ—Ç–∫–∞ 64√ó36, —Ç–∏–∫ 100–º—Å
- [ ] BattleRenderer: –∫—Ä—É–≥–∏ + –ª–∏–Ω–∏–∏
- [ ] –ü—É–ª—å—Å–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫
- [ ] BattleManager: state machine
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.ts
- [ ] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ª–∞–Ω–¥—à–∞—Ñ—Ç
- [ ] –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ
- [ ] TypeScript –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
- [ ] 60fps –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ

================================================================================
–ö–û–ù–ï–¶ –§–ê–ô–õ–ê
================================================================================
