================================================================================
DIGITAL HAND HOLDING - DEBUG FILES DUMP
================================================================================
Дата: 2026-02-16
Версия: v27
Статус: Работает create/join комнат, чат, PixiJS v8 инициализируется

================================================================================
=== client/index.html ===
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Hand Holding - Connect with Someone Special</title>
  <style>
    /* Стили опущены для краткости */
  </style>
</head>
<body>
  <div id="app">
    <!-- Landing Screen -->
    <div id="landingScreen" class="screen">
      <div style="font-size: 3rem; color: #ff00ff;">1</div>
      <h1>DIGITAL HAND HOLDING</h1>
      <p>Connect with someone special in a virtual space</p>
      <button id="createRoomBtn" class="btn">CREATE ROOM</button>
      <div style="margin-top: 20px;">
        <input type="text" id="roomIdInput" placeholder="Enter Room ID">
        <button id="joinRoomBtn" class="btn">JOIN ROOM</button>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen hidden">
      <div id="canvasContainer"></div>
      <div class="corner-circle top-left"></div>
      <div class="corner-circle top-right"></div>
      <div class="corner-circle bottom-left"></div>
      <div class="corner-circle bottom-right"></div>
      <button id="leftMenuBtn" class="btn">☰</button>
      <button id="menuBtn" class="btn">☰</button>
      <div id="centerPanel">
        <div id="centerRoomId">
          <span>Room ID: </span>
          <span id="currentRoomId" class="copyable-id"></span>
        </div>
        <div id="chat-container">
          <div id="chat-messages"></div>
          <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type your message...">
            <button id="chat-send-btn">Send</button>
          </div>
        </div>
      </div>
      <!-- Sidebars -->
    </div>
  </div>
  
  <script type="module" src="/src/main.ts"></script>
</body>
</html>
=== конец файла ===

================================================================================
=== client/src/main.ts ===
import { GameEngine } from './core/GameEngine';
import { NetworkManager } from './core/NetworkManager';
import { UIController } from './ui/UIController';
import { ChatManager } from './chat/ChatManager';

console.log('[MainApp] main.ts loaded');

class MainApp {
  private gameEngine!: GameEngine;
  private networkManager!: NetworkManager;
  private uiController!: UIController;
  private chatManager!: ChatManager;

  constructor() {
    console.log('[MainApp] Constructor started...');
    
    try {
      this.gameEngine = new GameEngine();
      this.networkManager = new NetworkManager();
      this.uiController = new UIController();
      this.chatManager = new ChatManager();
      
      this.setupInteractions();
      
      // Инициализация PixiJS (асинхронно)
      this.gameEngine.init('canvasContainer').then(() => {
        console.log('[MainApp] GameEngine initialized!');
        this.gameEngine.start();
      }).catch((error) => {
        console.error('[MainApp] GameEngine init ERROR:', error);
      });
      
      console.log('[MainApp] Constructor finished!');
    } catch (error) {
      console.error('[MainApp] Constructor ERROR:', error);
    }
  }

  private setupInteractions(): void {
    console.log('[MainApp] Setting up interactions...');
    
    this.uiController.onCreateRoom = async () => {
      console.log('[MainApp] onCreateRoom called!');
      try {
        const roomId = await this.networkManager.createRoom();
        console.log('[MainApp] Room created with ID:', roomId);
        
        this.uiController.setView('room');
        const room = this.networkManager.getCurrentRoom();
        if (room) {
          this.chatManager.attachToRoom(room);
          this.uiController.updateRoomIdFromRoom(room);
        }
        this.uiController.setPlayerName('Player 1');
      } catch (error) {
        console.error('[MainApp] ERROR in onCreateRoom:', error);
        alert('Create room ERROR: ' + error);
      }
    };

    this.uiController.onJoinRoom = async (roomId) => {
      console.log('[MainApp] onJoinRoom called with roomId:', roomId);
      try {
        await this.networkManager.joinRoom(roomId);
        console.log('[MainApp] Joined room successfully');
        this.uiController.setView('room');
        const room = this.networkManager.getCurrentRoom();
        if (room) {
          this.chatManager.attachToRoom(room);
          this.uiController.updateRoomIdFromRoom(room);
        }
        this.uiController.setPlayerName('Player 2');
      } catch (error) {
        console.error('[MainApp] ERROR in onJoinRoom:', error);
        alert('Join room ERROR: ' + error);
      }
    };
  }
}

console.log('[MainApp] Registering load event listener...');
window.addEventListener('load', () => {
  console.log('[MainApp] LOAD EVENT FIRED');
  new MainApp();
  console.log('MainApp() created!');
});
console.log('[MainApp] Load event listener registered');
=== конец файла ===

================================================================================
=== client/src/core/GameEngine.ts ===
import * as PIXI from 'pixi.js';

export class GameEngine {
  app: PIXI.Application | null = null;
  private ticker: PIXI.Ticker | null = null;

  constructor() {
    console.log('[GameEngine] Constructor called');
  }

  async init(containerId: string): Promise<void> {
    console.log('[GameEngine] Initializing PixiJS...');
    
    const container = document.getElementById(containerId);
    if (!container) {
      throw new Error(`Container element with id "${containerId}" not found`);
    }

    this.app = new PIXI.Application();
    
    await this.app.init({
      backgroundColor: 0x1a1a1a,
      width: window.innerWidth,
      height: window.innerHeight,
      antialias: true,
      autoDensity: true,
      resolution: Math.min(window.devicePixelRatio, 2),
    });

    this.ticker = this.app.ticker;
    container.appendChild(this.app.canvas);
    console.log('[GameEngine] Canvas appended');
  }

  start(): void {
    if (this.ticker) {
      this.ticker.start();
    }
  }
}
=== конец файла ===

================================================================================
=== client/src/core/NetworkManager.ts ===
import { Client } from 'colyseus.js';
import { Room } from 'colyseus.js';

export class NetworkManager {
  private client: Client;
  private currentRoom: Room | null = null;
  private readonly serverUrl: string;

  constructor(serverUrl?: string) {
    this.serverUrl = serverUrl || 'wss://cursor-hold-game-server.onrender.com';
    this.client = new Client(this.serverUrl);
    console.log('[NetworkManager] Server URL:', this.serverUrl);
  }

  async createRoom(): Promise<string> {
    console.log('[NetworkManager] createRoom() called');
    try {
      this.currentRoom = await this.client.joinOrCreate('holding_room');
      const roomId = this.currentRoom.state?.roomId || this.currentRoom.id;
      console.log('[NetworkManager] Room created:', roomId);
      return roomId;
    } catch (error) {
      console.error('[NetworkManager] ERROR in createRoom:', error);
      throw error;
    }
  }

  async joinRoom(roomId: string): Promise<Room> {
    console.log('[NetworkManager] joinRoom() called with roomId:', roomId);
    try {
      // ВРЕМЕННО: joinOrCreate попадёт в первую доступную комнату
      this.currentRoom = await this.client.joinOrCreate('holding_room');
      console.log('[NetworkManager] Joined room:', this.currentRoom.id);
      return this.currentRoom;
    } catch (error) {
      console.error('[NetworkManager] ERROR in joinRoom:', error);
      throw error;
    }
  }

  getCurrentRoom(): Room | null {
    return this.currentRoom;
  }

  onStateChange(callback: (state: any) => void): void {
    if (this.currentRoom) {
      this.currentRoom.onStateChange((state) => {
        callback(state);
      });
    }
  }

  getState() {
    if (this.currentRoom) {
      return this.currentRoom.state;
    }
    return null;
  }
}
=== конец файла ===

================================================================================
=== client/src/ui/UIController.ts ===
export class UIController {
  private lobbyContainer: HTMLElement;
  private roomContainer: HTMLElement;
  private createRoomBtn: HTMLButtonElement;
  private joinRoomBtn: HTMLButtonElement;
  private roomIdInput: HTMLInputElement;
  private currentView: 'lobby' | 'room' = 'lobby';

  constructor() {
    this.lobbyContainer = document.getElementById('landingScreen')!;
    this.roomContainer = document.getElementById('gameScreen')!;
    this.createRoomBtn = document.getElementById('createRoomBtn') as HTMLButtonElement;
    this.joinRoomBtn = document.getElementById('joinRoomBtn') as HTMLButtonElement;
    this.roomIdInput = document.getElementById('roomIdInput') as HTMLInputElement;
    this.setupEventListeners();
    this.setView('lobby');
  }

  private setupEventListeners(): void {
    this.createRoomBtn?.addEventListener('click', () => {
      this.onCreateRoomClick();
    });
    this.joinRoomBtn?.addEventListener('click', () => {
      this.onJoinRoomClick();
    });
  }

  private onCreateRoomClick(): void {
    if (this.onCreateRoom) {
      this.onCreateRoom();
    }
  }

  private onJoinRoomClick(): void {
    const roomId = this.roomIdInput?.value.trim();
    if (!roomId) {
      alert('Please enter a room ID');
      return;
    }
    if (this.onJoinRoom) {
      this.onJoinRoom(roomId);
    }
  }

  setView(view: 'lobby' | 'room'): void {
    if (view === 'lobby') {
      this.lobbyContainer.style.display = 'flex';
      this.roomContainer.style.display = 'none';
    } else {
      this.lobbyContainer.style.display = 'none';
      this.roomContainer.style.display = 'flex';
    }
  }

  showCreatedRoomId(roomId: string): void {
    const centerRoomIdElement = document.getElementById('currentRoomId');
    if (centerRoomIdElement) {
      centerRoomIdElement.textContent = roomId;
      centerRoomIdElement.classList.add('copyable-id');
      centerRoomIdElement.onclick = () => {
        navigator.clipboard.writeText(roomId);
      };
    }
  }

  updateRoomIdFromRoom(room: any): void {
    const roomId = room?.customRoomId || room?.state?.roomId || 'Unknown';
    this.showCreatedRoomId(roomId);
  }

  setPlayerName(name: string): void {
    const playerNameElement = document.getElementById('playerName');
    if (playerNameElement) {
      playerNameElement.textContent = name;
    }
  }

  updatePlayerCount(count: number, maxPlayers: number = 2): void {
    const playerCountElement = document.getElementById('playerCount');
    if (playerCountElement) {
      playerCountElement.textContent = `${count}/${maxPlayers}`;
    }
  }

  onCreateRoom?: () => void;
  onJoinRoom?: (roomId: string) => void;
}
=== конец файла ===

================================================================================
=== client/src/chat/ChatManager.ts ===
import { Room } from 'colyseus.js';

export class ChatManager {
  private room: Room | null = null;
  private chatContainer: HTMLElement;
  private messageInput: HTMLInputElement;
  private sendMessageBtn: HTMLButtonElement;

  constructor() {
    this.chatContainer = document.getElementById('chat-messages')!;
    this.messageInput = document.getElementById('chat-input') as HTMLInputElement;
    this.sendMessageBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;
    this.setupEventListeners();
  }

  attachToRoom(room: Room): void {
    this.room = room;
    this.room.onMessage('chatMessage', (data) => {
      this.receiveMessage(data.playerName, data.message, data.timestamp);
    });
  }

  sendMessage(): void {
    const message = this.messageInput?.value.trim();
    if (!message || !this.room) return;
    this.room.send('chatMessage', { message, timestamp: Date.now() });
    this.messageInput.value = '';
  }

  private receiveMessage(sender: string, message: string, timestamp: number): void {
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message';
    const timeString = new Date(timestamp).toLocaleTimeString();
    messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
    this.chatContainer.appendChild(messageElement);
    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
  }
}
=== конец файла ===

================================================================================
=== client/vite.config.ts ===
import { defineConfig } from 'vite';
import { resolve } from 'path';

export default defineConfig({
  base: '/',
  server: {
    port: 3000,
    host: true
  },
  build: {
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'index.html'),
      }
    },
    outDir: 'dist',
    emptyOutDir: true
  }
});
=== конец файла ===

================================================================================
=== client/package.json ===
{
  "name": "@holding-hands/client",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest"
  },
  "dependencies": {
    "@pixi/filter-bloom": "^5.1.1",
    "@pixi/filter-crt": "^5.1.1",
    "@pixi/filter-noise": "^5.3.12",
    "@pixi/filter-pixelate": "^5.1.1",
    "colyseus.js": "^0.15.28",
    "pixi.js": "^8.16.0"
  },
  "devDependencies": {
    "@types/jest": "^29.5.0",
    "@types/node": "^20.0.0",
    "@vitest/ui": "^1.0.0",
    "typescript": "^5.0.2",
    "vite": "^5.0.0",
    "vitest": "^1.0.0"
  }
}
=== конец файла ===

================================================================================
=== client/tsconfig.json ===
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src", "src/types/**/*.d.ts"]
}
=== конец файла ===

================================================================================
=== server/src/index.ts ===
import express from 'express';
import { Server } from 'colyseus';
import { createServer } from 'http';
import cors from 'cors';
import { HoldingRoom } from './rooms/HoldingRoom';

const PORT = Number(process.env.PORT || 2567);
const app = express();
app.use(cors());

const server = createServer(app);
const gameServer = new Server({ server });

gameServer.define('holding_room', HoldingRoom);

app.get('/health', (req, res) => {
  res.status(200).send('OK');
});

gameServer.listen(PORT);
console.log(`Listening on Port: ${PORT}`);
=== конец файла ===

================================================================================
=== server/src/rooms/schema.ts ===
import { Schema, type, MapSchema } from '@colyseus/schema';

export class PlayerSchema extends Schema {
  @type('string') id!: string;
  @type('string') name: string = '';
  @type('number') x: number = 0;
  @type('number') y: number = 0;
  @type('number') color: number = 0xffffff;
  @type('boolean') isHoldingHands: boolean = false;
  @type('string') holdingHandsWith: string = '';
  @type('boolean') isRoomCreator: boolean = false;
  @type('boolean') isReady: boolean = false;
  @type({ map: 'number' }) virusParams: Map<string, number> = new Map();
  @type('number') cursorX: number = 0;
  @type('number') cursorY: number = 0;
}

export class RoomState extends Schema {
  @type({ map: PlayerSchema }) players = new MapSchema<PlayerSchema>();
  @type('string') roomId: string = '';
  @type('number') maxPlayers: number = 2;
  @type({ array: 'number' }) battleGrid: number[] = [];
  @type('boolean') battleActive: boolean = false;
}
=== конец файла ===

================================================================================
КОНЕЦ ФАЙЛА
================================================================================
